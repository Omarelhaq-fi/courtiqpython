<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CourtIQ - Coach Board</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #1a202c; color: #e2e8f0; }
        #board-canvas { background-color: #2d3748; cursor: crosshair; touch-action: none; }
        .tool-btn, .player-token { transition: all 0.2s ease-in-out; }
        .tool-btn.active { background-color: #F97316; color: white; }
        .player-token { cursor: grab; background-color: #F97316; }
        .player-token:active { cursor: grabbing; }
        .player-list-item { cursor: grab; }
        .player-list-item:active { cursor: grabbing; }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden">

    <!-- Header / Toolbar -->
    <header class="bg-gray-800 p-3 flex items-center justify-between gap-4 flex-wrap">
        <h1 class="text-xl font-bold text-orange-500">Coach Board</h1>
        <div class="flex items-center gap-4 flex-wrap">
            <div class="flex items-center gap-2">
                <button id="pen-tool" class="tool-btn active bg-gray-700 p-2 rounded-md" title="Pen"><i class="fas fa-pencil-alt"></i></button>
                <button id="eraser-tool" class="tool-btn bg-gray-700 p-2 rounded-md" title="Eraser"><i class="fas fa-eraser"></i></button>
            </div>
            <div class="flex items-center gap-2">
                <input type="color" id="color-picker" value="#FFFFFF" class="w-10 h-10 bg-gray-700 rounded-md cursor-pointer">
            </div>
            <div class="flex items-center gap-2">
                <label for="line-width" class="text-sm">Width:</label>
                <input type="range" id="line-width" min="1" max="20" value="3" class="w-24">
            </div>
            <button id="clear-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md">Clear Board</button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex flex-1 overflow-hidden">
        <!-- Player Roster Sidebar -->
        <aside class="w-64 bg-gray-900 p-4 overflow-y-auto">
            <h2 class="text-lg font-bold mb-4">Your Players</h2>
            <div id="player-list" class="space-y-2">
                <p class="text-gray-400 text-sm">Loading players...</p>
            </div>
        </aside>

        <!-- Canvas -->
        <div id="canvas-container" class="flex-1 bg-gray-800 flex items-center justify-center p-4">
            <canvas id="board-canvas"></canvas>
        </div>
    </main>

    <script>
    const canvas = document.getElementById('board-canvas');
    const ctx = canvas.getContext('2d');
    const canvasContainer = document.getElementById('canvas-container');
    const playerListEl = document.getElementById('player-list');
    
    const penTool = document.getElementById('pen-tool');
    const eraserTool = document.getElementById('eraser-tool');
    const colorPicker = document.getElementById('color-picker');
    const lineWidthRange = document.getElementById('line-width');
    const clearBtn = document.getElementById('clear-btn');

    let isDrawing = false;
    let currentTool = 'pen';
    let paths = [];
    let playerTokens = [];
    let draggedToken = null;
    let offsetX, offsetY;

    function resizeCanvas() {
        const containerRect = canvasContainer.getBoundingClientRect();
        // Aspect ratio for a HORIZONTAL half court (47ft long x 50ft wide)
        const aspectRatio = 500 / 470; 
        let newHeight = containerRect.height - 32;
        let newWidth = newHeight * aspectRatio;

        if (newWidth > containerRect.width - 32) {
            newWidth = containerRect.width - 32;
            newHeight = newWidth / aspectRatio;
        }
        
        canvas.width = newWidth;
        canvas.height = newHeight;
        draw();
    }

    function drawCourt() {
        const w = canvas.width;
        const h = canvas.height;
        
        ctx.fillStyle = '#2d3748';
        ctx.fillRect(0, 0, w, h);

        // --- Define Court Geometry (Horizontal Half-Court) ---
        const scale = h / 50; // pixels per foot, based on 50ft court width
        const court = {
            keyWidth: 16 * scale,
            keyHeight: 19 * scale,
            hoopRadius: 0.75 * scale,
            hoopCenterX: 5.25 * scale,
            hoopCenterY: h / 2,
            backboardWidth: 6 * scale,
            backboardOffsetX: 4 * scale,
            threePointRadius: 22.15 * scale,
            threePointSideLineY: 2.95 * scale,
        };

        // --- Set default line style ---
        ctx.strokeStyle = '#6b7280';
        ctx.lineWidth = 2;
        ctx.lineCap = 'round';

        // --- Draw Key and Free Throw Circle ---
        ctx.strokeRect(0, (h - court.keyWidth) / 2, court.keyHeight, court.keyWidth);

        // Free throw circle (solid part)
        ctx.beginPath();
        ctx.arc(court.keyHeight, court.hoopCenterY, court.keyWidth / 2, -Math.PI / 2, Math.PI / 2, false);
        ctx.stroke();

        // Free throw circle (dashed part)
        ctx.beginPath();
        ctx.setLineDash([5, 5]);
        ctx.arc(court.keyHeight, court.hoopCenterY, court.keyWidth / 2, Math.PI / 2, -Math.PI / 2, false);
        ctx.stroke();
        ctx.setLineDash([]);

        // --- Draw Three-Point Line ---
        const dx = Math.sqrt(Math.max(0, court.threePointRadius**2 - (h/2 - court.threePointSideLineY)**2));
        const arcIntersectionX = court.hoopCenterX + dx;
        
        const startAngle = -Math.atan2(h/2 - court.threePointSideLineY, arcIntersectionX - court.hoopCenterX);
        const endAngle = -startAngle;

        ctx.beginPath();
        ctx.moveTo(arcIntersectionX, court.threePointSideLineY);
        ctx.lineTo(0, court.threePointSideLineY); // Top straight line
        ctx.moveTo(0, h - court.threePointSideLineY); // Bottom straight line
        ctx.lineTo(arcIntersectionX, h - court.threePointSideLineY);
        ctx.arc(court.hoopCenterX, court.hoopCenterY, court.threePointRadius, startAngle, endAngle, false); // Arc
        ctx.stroke();

        // --- Draw Backboard ---
        ctx.beginPath();
        ctx.moveTo(court.backboardOffsetX, (h - court.backboardWidth) / 2);
        ctx.lineTo(court.backboardOffsetX, (h + court.backboardWidth) / 2);
        ctx.lineWidth = 4;
        ctx.stroke();

        // --- Draw Hoop ---
        ctx.beginPath();
        ctx.arc(court.hoopCenterX, court.hoopCenterY, court.hoopRadius, 0, 2 * Math.PI);
        ctx.lineWidth = 2;
        ctx.strokeStyle = '#F97316';
        ctx.stroke();
        
        ctx.strokeStyle = '#6b7280';
    }

    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        drawCourt();

        paths.forEach(path => {
            ctx.beginPath();
            ctx.strokeStyle = path.color;
            ctx.lineWidth = path.width;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            path.points.forEach((point, index) => {
                if (index === 0) ctx.moveTo(point.x, point.y);
                else ctx.lineTo(point.x, point.y);
            });
            ctx.stroke();
        });
        
        playerTokens.forEach(token => {
            ctx.beginPath();
            ctx.arc(token.x, token.y, 20, 0, Math.PI * 2);
            ctx.fillStyle = '#F97316';
            ctx.fill();
            ctx.strokeStyle = 'white';
            ctx.lineWidth = 2;
            ctx.stroke();
            ctx.fillStyle = 'white';
            ctx.font = 'bold 16px Inter';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(token.number, token.x, token.y);
        });
    }
    
    function startDrawing(e) {
        e.preventDefault();
        const pos = getCanvasPos(e);
        
        draggedToken = playerTokens.find(token => 
            Math.sqrt((pos.x - token.x)**2 + (pos.y - token.y)**2) < 20
        );

        if (draggedToken) {
            isDrawing = false;
            offsetX = pos.x - draggedToken.x;
            offsetY = pos.y - draggedToken.y;
        } else {
            isDrawing = true;
            const newPath = {
                color: currentTool === 'pen' ? colorPicker.value : '#2d3748',
                width: currentTool === 'pen' ? lineWidthRange.value : 25,
                points: [{ x: pos.x, y: pos.y }]
            };
            paths.push(newPath);
        }
    }

    function drawOnMove(e) {
        if (!isDrawing && !draggedToken) return;
        e.preventDefault();
        const pos = getCanvasPos(e);

        if (draggedToken) {
            draggedToken.x = pos.x - offsetX;
            draggedToken.y = pos.y - offsetY;
        } else if (isDrawing) {
            paths[paths.length - 1].points.push({ x: pos.x, y: pos.y });
        }
        draw();
    }

    function stopDrawing() {
        isDrawing = false;
        draggedToken = null;
    }

    function getCanvasPos(e) {
        const rect = canvas.getBoundingClientRect();
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
        let x, y;
        if (e.touches) {
            x = (e.touches[0].clientX - rect.left) * scaleX;
            y = (e.touches[0].clientY - rect.top) * scaleY;
        } else {
            x = (e.clientX - rect.left) * scaleX;
            y = (e.clientY - rect.top) * scaleY;
        }
        return { x, y };
    }

    async function fetchAndRenderPlayers() {
        try {
            const response = await fetch('/api/players');
            const players = await response.json();
            playerListEl.innerHTML = players.map(p => `
                <div class="player-list-item bg-gray-700 p-2 rounded-md flex items-center gap-2" draggable="true" data-player-id="${p.id}" data-player-name="${p.name}" data-player-number="${p.number}">
                    <div class="bg-orange-500 text-white w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm flex-shrink-0">${p.number}</div>
                    <span class="font-medium text-sm">${p.name}</span>
                </div>
            `).join('');
            
            document.querySelectorAll('.player-list-item').forEach(item => {
                item.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', JSON.stringify({
                        id: e.target.dataset.playerId,
                        name: e.target.dataset.playerName,
                        number: e.target.dataset.playerNumber
                    }));
                });
            });

        } catch (error) {
            playerListEl.innerHTML = '<p class="text-red-400 text-sm">Failed to load players.</p>';
        }
    }
    
    // Event Listeners
    window.addEventListener('resize', resizeCanvas);
    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mousemove', drawOnMove);
    canvas.addEventListener('mouseup', stopDrawing);
    canvas.addEventListener('mouseleave', stopDrawing);
    canvas.addEventListener('touchstart', startDrawing);
    canvas.addEventListener('touchmove', drawOnMove);
    canvas.addEventListener('touchend', stopDrawing);
    
    clearBtn.addEventListener('click', () => {
        paths = [];
        playerTokens = [];
        draw();
    });
    
    penTool.addEventListener('click', () => {
        currentTool = 'pen';
        penTool.classList.add('active');
        eraserTool.classList.remove('active');
    });

    eraserTool.addEventListener('click', () => {
        currentTool = 'eraser';
        eraserTool.classList.add('active');
        penTool.classList.remove('active');
    });
    
    canvas.addEventListener('dragover', (e) => e.preventDefault());
    canvas.addEventListener('drop', (e) => {
        e.preventDefault();
        const playerData = JSON.parse(e.dataTransfer.getData('text/plain'));
        const pos = getCanvasPos(e);
        
        if (!playerTokens.some(token => token.id === playerData.id)) {
            playerTokens.push({
                id: playerData.id,
                name: playerData.name,
                number: playerData.number,
                x: pos.x,
                y: pos.y
            });
            draw();
        }
    });

    // Initial setup
    resizeCanvas();
    fetchAndRenderPlayers();
    </script>
</body>
</html>
