<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CourtIQ Scouting Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #1a202c; color: #e2e8f0; }
        .card { background-color: rgba(45, 55, 72, 0.85); border: 1px solid rgba(74, 85, 104, 0.8); }
        .btn-stat:hover { transform: scale(1.05); }
        .timer-btn.active { background-color: #c53030; }
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); display: flex; justify-content: center; align-items: center; z-index: 50; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="app-container" class="mx-auto relative z-10">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-orange-500">CourtIQ Scouting Panel</h1>
        </header>

        <!-- Scoreboard & Controls -->
        <div class="card p-6 rounded-lg shadow-lg mb-8">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-center">
                <div>
                    <label for="teamName" class="block text-sm font-medium text-gray-400">Your Team Name</label>
                    <input id="teamName" type="text" placeholder="Enter Team Name" class="w-full bg-slate-700 border border-slate-600 rounded-md p-3 mt-1">
                    <p id="yourTeamScore" class="text-6xl font-bold text-center mt-2">0</p>
                </div>
                <div class="text-center">
                    <p id="gameTimerDisplay" class="text-5xl font-mono font-bold">00:00</p>
                    <button id="gameTimerBtn" class="mt-4 w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-md">Start Game</button>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-slate-400 text-center">Opponent Score</h3>
                    <p id="opponentScore" class="text-6xl font-bold text-center mt-2">0</p>
                    <div class="flex justify-center gap-2 mt-4">
                        <button class="bg-slate-600 hover:bg-slate-700 text-white font-bold py-1 px-3 rounded" onclick="app.addOpponentPoints(1)">+1</button>
                        <button class="bg-slate-600 hover:bg-slate-700 text-white font-bold py-1 px-3 rounded" onclick="app.addOpponentPoints(2)">+2</button>
                        <button class="bg-slate-600 hover:bg-slate-700 text-white font-bold py-1 px-3 rounded" onclick="app.addOpponentPoints(3)">+3</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Scouting Panel -->
        <div id="scoutingPanel" class="flex flex-wrap gap-4 justify-center">
            <p id="loadingMessage" class="text-lg text-gray-400">Loading players...</p>
        </div>

        <!-- Generate Report Button -->
        <div class="mt-8 text-center">
            <button id="generateReportBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-md">Save Report & Finish</button>
        </div>
    </div>

    <!-- Modals -->
    <div id="detailModal" class="modal-backdrop hidden"></div>
    <div id="notificationModal" class="modal-backdrop hidden"></div>

    <script>
        const app = {
            players: [],
            opponentScore: 0,
            gameTime: 0,
            gameTimerInterval: null,
            isGameTimerRunning: false,

            init() {
                this.cacheDOMElements();
                this.addEventListeners();
                this.fetchPlayers();
            },

            cacheDOMElements() {
                this.scoutingPanel = document.getElementById('scoutingPanel');
                this.loadingMessage = document.getElementById('loadingMessage');
                this.gameTimerDisplay = document.getElementById('gameTimerDisplay');
                this.gameTimerBtn = document.getElementById('gameTimerBtn');
                this.yourTeamScoreEl = document.getElementById('yourTeamScore');
                this.opponentScoreEl = document.getElementById('opponentScore');
                this.teamNameInput = document.getElementById('teamName');
                this.generateReportBtn = document.getElementById('generateReportBtn');
            },

            addEventListeners() {
                this.gameTimerBtn.addEventListener('click', () => this.handleGameTimer());
                this.generateReportBtn.addEventListener('click', () => this.saveReport());
            },
            
            async fetchPlayers() {
                try {
                    const response = await fetch('/api/players');
                    if (!response.ok) throw new Error('Failed to fetch players');
                    const playersFromDB = await response.json();
                    
                    this.players = playersFromDB.map(p => ({
                        id: p.id, name: p.name, number: p.number || 'N/A',
                        minutes: 0, timerInterval: null, isTimerRunning: false,
                        points: 0, rebounds: 0, offensiveRebounds: 0, defensiveRebounds: 0,
                        assists: 0, steals: 0, blocks: 0, timesBlocked: 0, turnovers: 0, personalFouls: 0,
                        turnoverDetails: { missPass: 0, stolen: 0, byBlock: 0, shotClock: 0, travelling: 0, doubleDribble: 0, outOfBounds: 0, backcourt: 0 },
                        foulDetails: { defensive: 0, offensive: 0, technical: 0, unsportsmanlike: 0 },
                        fg2a: 0, fg2m: 0, fg3a: 0, fg3m: 0, fta: 0, ftm: 0,
                        shots: [],
                    }));
                    this.render();
                } catch (error) {
                    this.loadingMessage.textContent = 'Failed to load players.';
                }
            },

            handleGameTimer() {
                this.isGameTimerRunning = !this.isGameTimerRunning;
                if (this.isGameTimerRunning) {
                    this.players.forEach(p => this.handlePlayerTimer(p.id, true)); // Start all timers
                    this.gameTimerInterval = setInterval(() => {
                        this.gameTime++;
                        this.renderGameTimer();
                    }, 1000);
                } else {
                    this.players.forEach(p => this.handlePlayerTimer(p.id, false)); // Stop all timers
                    clearInterval(this.gameTimerInterval);
                }
                this.renderGameTimer();
            },
            
            handlePlayerTimer(playerId, forceStart = null) {
                const player = this.players.find(p => p.id === playerId);
                if (!player) return;

                const shouldBeRunning = forceStart !== null ? forceStart : !player.isTimerRunning;

                if (shouldBeRunning && !player.isTimerRunning) {
                    player.isTimerRunning = true;
                    player.timerInterval = setInterval(() => {
                        player.minutes++;
                        this.render();
                    }, 1000);
                } else if (!shouldBeRunning && player.isTimerRunning) {
                    player.isTimerRunning = false;
                    clearInterval(player.timerInterval);
                }
                this.render();
            },

            handleShot(playerId, type, made) {
                const player = this.players.find(p => p.id === playerId);
                if (!player) return;
                player[`${type}a`]++;
                if (made) {
                    player[`${type}m`]++;
                    player.points += (type === 'fg2' ? 2 : 3);
                }
                this.render();
            },
            
            handleFreeThrow(playerId, made) {
                const player = this.players.find(p => p.id === playerId);
                if (!player) return;
                player.fta++;
                if(made) {
                    player.ftm++;
                    player.points++;
                }
                this.render();
            },
            
            incrementStat(playerId, stat) {
                const player = this.players.find(p => p.id === playerId);
                if (player) {
                    player[stat]++;
                    this.render();
                }
            },
            
            addOpponentPoints(points) {
                this.opponentScore += points;
                this.renderScores();
            },

            async saveReport() {
                this.generateReportBtn.disabled = true;
                this.generateReportBtn.textContent = 'Saving...';

                const reportData = {
                    teamName: this.teamNameInput.value.trim() || 'My Team',
                    opponentScore: this.opponentScore,
                    players: this.players
                };

                try {
                    const response = await fetch('/api/save_report', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(reportData)
                    });
                    const result = await response.json();
                    if (result.success) {
                        this.showNotification(`Report saved successfully! You can view it in the Dashboard.`, true);
                        setTimeout(() => window.location.href = '/dashboard', 2000);
                    } else {
                        throw new Error(result.message || 'Failed to save report.');
                    }
                } catch (error) {
                    this.showNotification(`Error: ${error.message}`, false);
                    this.generateReportBtn.disabled = false;
                    this.generateReportBtn.textContent = 'Save Report & Finish';
                }
            },
            
            showNotification(message, isSuccess) {
                const modal = document.getElementById('notificationModal');
                modal.innerHTML = `
                    <div class="card p-6 rounded-lg text-center max-w-sm">
                        <h3 class="text-xl font-semibold mb-4 ${isSuccess ? 'text-green-400' : 'text-red-400'}">${isSuccess ? 'Success' : 'Error'}</h3>
                        <p>${message}</p>
                    </div>
                `;
                modal.classList.remove('hidden');
                if (isSuccess) {
                    setTimeout(() => modal.classList.add('hidden'), 2000);
                } else {
                    modal.addEventListener('click', () => modal.classList.add('hidden'), { once: true });
                }
            },

            formatTime: (s) => `${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`,

            renderGameTimer() {
                this.gameTimerDisplay.textContent = this.formatTime(this.gameTime);
                this.gameTimerBtn.textContent = this.isGameTimerRunning ? 'Stop Game' : 'Start Game';
                this.gameTimerBtn.classList.toggle('bg-red-600', this.isGameTimerRunning);
                this.gameTimerBtn.classList.toggle('hover:bg-red-700', this.isGameTimerRunning);
                this.gameTimerBtn.classList.toggle('bg-green-600', !this.isGameTimerRunning);
                this.gameTimerBtn.classList.toggle('hover:bg-green-700', !this.isGameTimerRunning);
            },
            
            renderScores() {
                this.yourTeamScoreEl.textContent = this.players.reduce((total, p) => total + p.points, 0);
                this.opponentScoreEl.textContent = this.opponentScore;
            },

            render() {
                if (this.players.length === 0) {
                    this.loadingMessage.textContent = 'No players assigned or available for scouting.';
                    return;
                }
                this.loadingMessage.style.display = 'none';
                
                this.renderScores();

                this.scoutingPanel.innerHTML = this.players.map(p => `
                    <div class="card p-3 rounded-lg shadow-md w-full sm:w-[calc(50%-0.5rem)] md:w-[calc(33.333%-0.67rem)]">
                        <div class="flex justify-between items-start mb-3 pb-2 border-b border-slate-600">
                            <div>
                                <h3 class="text-lg font-bold text-orange-400">${p.name}</h3>
                                <p class="text-sm text-slate-400">#${p.number}</p>
                            </div>
                            <div class="text-right">
                                <button class="timer-btn ${p.isTimerRunning ? 'active' : 'bg-green-600'} text-white font-semibold py-2 px-3 rounded-md text-xs" onclick="app.handlePlayerTimer(${p.id})">${p.isTimerRunning ? 'PAUSE' : 'PLAY'}</button>
                                <p class="text-xl font-mono font-bold mt-1">${this.formatTime(p.minutes)}</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-3 gap-2 mb-3 text-center">
                            <div><p class="text-xl font-bold">${p.points}</p><p class="text-xs text-slate-400">Points</p></div>
                            <div><p class="text-xl font-bold">${p.rebounds}</p><button class="btn-stat text-xs bg-slate-600 w-full mt-1 py-1 rounded" onclick="app.incrementStat(${p.id}, 'rebounds')">REB</button></div>
                            <div><p class="text-xl font-bold">${p.assists}</p><button class="btn-stat text-xs bg-slate-600 w-full mt-1 py-1 rounded" onclick="app.incrementStat(${p.id}, 'assists')">AST</button></div>
                        </div>
                        <div class="border-t border-slate-600 pt-3">
                            <h4 class="font-semibold mb-2 text-center">Shooting</h4>
                            <div class="grid grid-cols-3 gap-2">
                                <div class="text-center"><p class="font-bold text-sm">2PT: ${p.fg2m}-${p.fg2a}</p><div class="flex justify-center gap-1 mt-1"><button class="btn-stat bg-green-500 text-white text-xs font-bold py-1 px-2 rounded" onclick="app.handleShot(${p.id}, 'fg2', true)">M</button><button class="btn-stat bg-red-500 text-white text-xs font-bold py-1 px-2 rounded" onclick="app.handleShot(${p.id}, 'fg2', false)">X</button></div></div>
                                <div class="text-center"><p class="font-bold text-sm">3PT: ${p.fg3m}-${p.fg3a}</p><div class="flex justify-center gap-1 mt-1"><button class="btn-stat bg-green-500 text-white text-xs font-bold py-1 px-2 rounded" onclick="app.handleShot(${p.id}, 'fg3', true)">M</button><button class="btn-stat bg-red-500 text-white text-xs font-bold py-1 px-2 rounded" onclick="app.handleShot(${p.id}, 'fg3', false)">X</button></div></div>
                                <div class="text-center"><p class="font-bold text-sm">FT: ${p.ftm}-${p.fta}</p><div class="flex justify-center gap-1 mt-1"><button class="btn-stat bg-green-500 text-white text-xs font-bold py-1 px-2 rounded" onclick="app.handleFreeThrow(${p.id}, true)">M</button><button class="btn-stat bg-red-500 text-white text-xs font-bold py-1 px-2 rounded" onclick="app.handleFreeThrow(${p.id}, false)">X</button></div></div>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
        };

        document.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>
